{
  "name": "Improve Test Coverage and Create PR",
  "description": "Improves all test files, applies patches, creates a new branch, commits, pushes, and opens a PR.",
  "steps": [
    {
      "title": "Find test files",
      "action": {
        "type": "shell",
        "run": "git ls-files | grep -E '\\.(test|spec)\\.(ts|js)$' || true"
      },
      "output_to": "test_files"
    },
    {
      "title": "Improve test coverage",
      "action": {
        "type": "agent",
        "task": "Improve test coverage for the following test files. Add edge cases, negative tests, mocks, branches and missing assertions.\n\nFiles:\n{{test_files}}\n\nReturn a valid unified patch."
      },
      "output_to": "updated_tests"
    },
    {
      "title": "Apply patch",
      "action": {
        "type": "apply_patch",
        "patch": "{{updated_tests}}"
      }
    },
    {
      "title": "Get current branch",
      "action": {
        "type": "shell",
        "run": "git rev-parse --abbrev-ref HEAD"
      },
      "output_to": "current_branch"
    },
    {
      "title": "Create new branch",
      "action": {
        "type": "shell",
        "run": "timestamp=$(date +%Y%m%d-%H%M%S); new_branch=\"feature-improved-test-coverage-$timestamp\"; git checkout -b $new_branch; echo $new_branch"
      },
      "output_to": "new_branch"
    },
    {
      "title": "Add changes",
      "action": {
        "type": "shell",
        "run": "git add ."
      }
    },
    {
      "title": "Commit changes",
      "action": {
        "type": "shell",
        "run": "git commit -m \"chore: improve test coverage automatically\" || echo 'No changes to commit'"
      }
    },
    {
      "title": "Push branch",
      "action": {
        "type": "shell",
        "run": "git push --set-upstream origin {{new_branch}}"
      }
    },
    {
      "title": "Ask for GitHub token",
      "action": {
        "type": "agent",
        "task": "Please provide your GitHub token (GITHUB_TOKEN). It will be used once to create the PR."
      },
      "output_to": "git_token"
    },
    {
      "title": "Create Pull Request",
      "action": {
        "type": "shell",
        "run": "curl -X POST \
-H \"Authorization: token {{git_token}}\" \
-H \"Accept: application/vnd.github+json\" \
https://api.github.com/repos/imguccho/code-coverage-analysis/pulls \
-d '{\"title\":\"Improve Test Coverage Automatically\",\"body\":\"This PR was generated automatically using Cline.\",\"head\":\"{{new_branch}}\",\"base\":\"{{current_branch}}\"}'"
      }
    }
  ]
}
